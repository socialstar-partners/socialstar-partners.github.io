<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialStar - Get Ratings</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .rating-container {
            margin: 30px 0;
        }

        .stars {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 20px 0;
        }

        .star {
            font-size: 2.5em;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #ffd700;
            transform: scale(1.1);
        }

        .average-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .rating-count {
            color: #888;
            font-size: 1.1em;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            min-width: 200px;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-large {
            font-size: 1.3em;
            padding: 20px 40px;
            margin: 20px 0;
        }

        .link-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .generated-link {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9em;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            font-weight: bold;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: left;
        }

        .instructions h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin: 8px 0;
        }

        .rating-prompt {
            font-size: 1.2em;
            color: #333;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .stars {
                gap: 2px;
            }
            
            .star {
                font-size: 2em;
            }
            
            .btn {
                min-width: 150px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="logo">‚≠ê SocialStar</h1>
            <p class="subtitle">Get your photos rated by friends!</p>
            
            <!-- Generate Link Section -->
            <div id="generateSection">
                <p style="margin: 30px 0; font-size: 1.1em; color: #555;">
                    Create a rating link to add to your Instagram story or post
                </p>
                <button class="btn btn-large" id="generateBtn">üîó Generate My Rating Link</button>
                
                <div class="instructions">
                    <h4>How it works:</h4>
                    <ol>
                        <li>Click "Generate My Rating Link" above</li>
                        <li>Copy the link and add it to your Instagram story/post</li>
                        <li>Friends click the link and rate your photo 1-5 stars</li>
                        <li>Come back here to see your average rating!</li>
                    </ol>
                </div>
            </div>

            <!-- Link Generated Section -->
            <div id="linkSection" class="hidden">
                <div class="success-message">
                    üéâ Your rating link is ready!
                </div>
                <div class="link-container">
                    <p><strong>Add this link to your Instagram story/post:</strong></p>
                    <div class="generated-link" id="generatedLink"></div>
                    <button class="btn btn-secondary" id="copyBtn">üìã Copy Link</button>
                    <button class="btn" id="viewResultsBtn">üìä View Results</button>
                </div>
                <button class="btn" id="newLinkBtn">üÜï Generate New Link</button>
            </div>

            <!-- Rating Section (for when friends click the link) -->
            <div id="ratingSection" class="hidden">
                <h2>Rate this photo! üì∏</h2>
                <p class="rating-prompt">How many stars do you give this photo?</p>
                <div class="rating-container">
                    <div class="stars" id="starRating">
                        <span class="star" data-rating="1">‚≠ê</span>
                        <span class="star" data-rating="2">‚≠ê</span>
                        <span class="star" data-rating="3">‚≠ê</span>
                        <span class="star" data-rating="4">‚≠ê</span>
                        <span class="star" data-rating="5">‚≠ê</span>
                    </div>
                    <button class="btn btn-large" id="submitRatingBtn" disabled>Submit Rating</button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <h2>üìä Rating Results</h2>
                <div class="average-display" id="averageDisplay">0.0 ‚≠ê</div>
                <div class="rating-count" id="ratingCount">0 ratings</div>
                <button class="btn" id="refreshBtn">üîÑ Refresh Results</button>
                <button class="btn btn-secondary" id="shareAgainBtn">üì± Share Link Again</button>
            </div>

            <!-- Thank You Section -->
            <div id="thankYouSection" class="hidden">
                <h2>üåü Thank you for rating!</h2>
                <p style="margin: 20px 0; font-size: 1.1em;">Your rating has been submitted successfully.</p>
                
                <!-- Show results after rating -->
                <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìä Rating Results</h3>
                    <div class="average-display" id="thankYouAverage">0.0 ‚≠ê</div>
                    <div class="rating-count" id="thankYouCount">0 ratings</div>
                </div>
                
                <a href="/" class="btn">Create Your Own Rating Link</a>
            </div>

            <!-- Messages -->
            <div id="messageArea"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js';
        import { getFirestore, collection, doc, addDoc, getDoc, updateDoc, onSnapshot, setDoc, increment } from 'https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCbofaQa-No-oxgTUsHPV1ZGl7XTekgCro",
            authDomain: "ss-web-rate.firebaseapp.com",
            projectId: "ss-web-rate",
            storageBucket: "ss-web-rate.firebasestorage.app",
            messagingSenderId: "620089536789",
            appId: "1:620089536789:web:59a52c173bed01ecccf91c",
            measurementId: "G-E71Y9TK6ZJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let currentLinkId = null;
        let selectedRating = 0;

        // DOM elements
        const generateSection = document.getElementById('generateSection');
        const linkSection = document.getElementById('linkSection');
        const ratingSection = document.getElementById('ratingSection');
        const resultsSection = document.getElementById('resultsSection');
        const thankYouSection = document.getElementById('thankYouSection');
        const generateBtn = document.getElementById('generateBtn');
        const generatedLink = document.getElementById('generatedLink');
        const copyBtn = document.getElementById('copyBtn');
        const viewResultsBtn = document.getElementById('viewResultsBtn');
        const newLinkBtn = document.getElementById('newLinkBtn');
        const starRating = document.getElementById('starRating');
        const submitRatingBtn = document.getElementById('submitRatingBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const shareAgainBtn = document.getElementById('shareAgainBtn');
        const messageArea = document.getElementById('messageArea');

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const ratingId = urlParams.get('rate');
        const resultsId = urlParams.get('results');
        
        if (ratingId) {
            loadRatingPage(ratingId);
        } else if (resultsId) {
            loadResultsPage(resultsId);
        } else {
            showGenerateSection();
        }

        // Button handlers
        generateBtn.addEventListener('click', generateRatingLink);
        copyBtn.addEventListener('click', copyLink);
        viewResultsBtn.addEventListener('click', viewResults);
        newLinkBtn.addEventListener('click', resetApp);
        submitRatingBtn.addEventListener('click', submitRating);
        refreshBtn.addEventListener('click', () => loadResultsPage(currentLinkId));
        shareAgainBtn.addEventListener('click', shareAgain);

        // Star rating handlers
        if (starRating) {
            starRating.addEventListener('click', handleStarClick);
            starRating.addEventListener('mouseover', handleStarHover);
            starRating.addEventListener('mouseleave', handleStarLeave);
        }

        async function generateRatingLink() {
            try {
                showLoading('Creating your link...');
                
                // Create new rating entry in Firestore
                const webRatingsRef = collection(db, 'web-ratings');
                const newRatingDoc = await addDoc(webRatingsRef, {
                    createdAt: new Date(),
                    totalRating: 0,
                    ratingCount: 0,
                    averageRating: 0
                });

                currentLinkId = newRatingDoc.id;
                const ratingUrl = `${window.location.origin}${window.location.pathname}?rate=${currentLinkId}`;
                
                generatedLink.textContent = ratingUrl;
                
                hideLoading();
                showLinkSection();
                showMessage('Your rating link is ready! üéâ', 'success');
                
            } catch (error) {
                hideLoading();
                showMessage('Error creating link. Please check your Firebase configuration.', 'error');
                console.error('Error:', error);
            }
        }

        async function loadRatingPage(ratingId) {
            try {
                const ratingDocRef = doc(db, 'web-ratings', ratingId);
                const snapshot = await getDoc(ratingDocRef);
                
                if (snapshot.exists()) {
                    currentLinkId = ratingId;
                    showRatingSection();
                } else {
                    showMessage('Rating link not found!', 'error');
                    showGenerateSection();
                }
            } catch (error) {
                showMessage('Error loading rating page.', 'error');
                showGenerateSection();
                console.error('Error:', error);
            }
        }

        async function loadResultsPage(resultsId) {
            try {
                const ratingDocRef = doc(db, 'web-ratings', resultsId);
                currentLinkId = resultsId;
                
                // Listen for real-time updates
                onSnapshot(ratingDocRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        updateResultsDisplay(data);
                        showResultsSection();
                    } else {
                        showMessage('Results not found!', 'error');
                        showGenerateSection();
                    }
                });
                
            } catch (error) {
                showMessage('Error loading results.', 'error');
                console.error('Error:', error);
            }
        }

        function handleStarClick(e) {
            if (e.target.classList.contains('star')) {
                selectedRating = parseInt(e.target.dataset.rating);
                updateStarDisplay(selectedRating);
                submitRatingBtn.disabled = false;
            }
        }

        function handleStarHover(e) {
            if (e.target.classList.contains('star')) {
                const rating = parseInt(e.target.dataset.rating);
                updateStarDisplay(rating);
            }
        }

        function handleStarLeave() {
            updateStarDisplay(selectedRating);
        }

        function updateStarDisplay(rating) {
            const stars = starRating.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        async function submitRating() {
            if (selectedRating === 0 || !currentLinkId) return;

            try {
                const ratingDocRef = doc(db, 'web-ratings', currentLinkId);
                const ratingsCollectionRef = collection(ratingDocRef, 'ratings');
                
                // Generate a unique user ID for this rating
                const userId = 'user_' + Math.random().toString(36).substr(2, 9);
                
                // Add the individual rating to the ratings subcollection
                await addDoc(ratingsCollectionRef, {
                    rating: selectedRating,
                    timestamp: new Date(),
                    userId: userId
                });
                
                // Update the main document with incremented totals
                await updateDoc(ratingDocRef, {
                    totalRating: increment(selectedRating),
                    ratingCount: increment(1)
                });
                
                // Get updated data to calculate new average and show results
                const updatedDoc = await getDoc(ratingDocRef);
                const data = updatedDoc.data();
                const newAverage = data.totalRating / data.ratingCount;
                
                await updateDoc(ratingDocRef, {
                    averageRating: newAverage
                });
                
                // Show results in thank you section
                document.getElementById('thankYouAverage').textContent = `${newAverage.toFixed(1)} ‚≠ê`;
                document.getElementById('thankYouCount').textContent = `${data.ratingCount} ratings`;
                
                showThankYouSection();
                showMessage('Thank you for your rating! üåü', 'success');
                
            } catch (error) {
                showMessage('Error submitting rating. Please try again.', 'error');
                console.error('Error:', error);
            }
        }

        function updateResultsDisplay(data) {
            document.getElementById('averageDisplay').textContent = `${(data.averageRating || 0).toFixed(1)} ‚≠ê`;
            document.getElementById('ratingCount').textContent = `${data.ratingCount || 0} ratings`;
        }

        function copyLink() {
            const link = generatedLink.textContent;
            navigator.clipboard.writeText(link).then(() => {
                showMessage('Link copied! Now paste it in your Instagram story üìã', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('Link copied! Now paste it in your Instagram story üìã', 'success');
            });
        }

        function viewResults() {
            const resultsUrl = `${window.location.origin}${window.location.pathname}?results=${currentLinkId}`;
            window.location.href = resultsUrl;
        }

        function shareAgain() {
            const ratingUrl = `${window.location.origin}${window.location.pathname}?rate=${currentLinkId}`;
            navigator.clipboard.writeText(ratingUrl).then(() => {
                showMessage('Rating link copied again! üìã', 'success');
            });
        }

        function resetApp() {
            currentLinkId = null;
            selectedRating = 0;
            showGenerateSection();
            window.history.pushState({}, '', window.location.pathname);
        }

        function showGenerateSection() {
            generateSection.classList.remove('hidden');
            linkSection.classList.add('hidden');
            ratingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            thankYouSection.classList.add('hidden');
        }

        function showLinkSection() {
            generateSection.classList.add('hidden');
            linkSection.classList.remove('hidden');
            ratingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            thankYouSection.classList.add('hidden');
        }

        function showRatingSection() {
            generateSection.classList.add('hidden');
            linkSection.classList.add('hidden');
            ratingSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            thankYouSection.classList.add('hidden');
        }

        function showResultsSection() {
            generateSection.classList.add('hidden');
            linkSection.classList.add('hidden');
            ratingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            thankYouSection.classList.add('hidden');
        }

        function showThankYouSection() {
            generateSection.classList.add('hidden');
            linkSection.classList.add('hidden');
            ratingSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            thankYouSection.classList.remove('hidden');
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messageArea.innerHTML = '';
            messageArea.appendChild(messageDiv);
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function showLoading(message) {
            generateBtn.innerHTML = message + '<span class="loading"></span>';
            generateBtn.disabled = true;
        }

        function hideLoading() {
            generateBtn.innerHTML = 'üîó Generate My Rating Link';
            generateBtn.disabled = false;
        }
    </script>
</body>
</html>
